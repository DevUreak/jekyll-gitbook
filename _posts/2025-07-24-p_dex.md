---
title: "[Project] Fully On-chain DEX"
author: Tao He
date: 2021-08-10
category: Jekyll
layout: post
---

Overview
-------------

Fully On-chain Dex는 매칭 엔진을 Smart Contract로 마이그레이션하여 온체인환경에 적합한 탈중앙화된 오더북을 구동하는것이다.
초기 [Clober Finance V1](https://github.com/clober-dex) 모델에 영감을 받았으며, 자동화된 유동성 분배 알고리즘을 개발하여 기존 AMM에 비해 매칭엔진에서 소모되는 Gas비를 줄여 결과적으로  트레이딩에 사용되는 슬리피지를 줄임과 동시에 사용자에게 다양한 주문 옵션을 제공하려는것이 가장 큰 목표 이다.

모든 섹션에서는 **기여한 부분과 공개가능한** 부분만 설명하고자한다. 
- 분석및 연구에 대한 내용은 투고한 논문을 통해서 확인가능하다. <br>
        * [원문](https://drive.google.com/file/d/1Lk0NbaKR5synhVLe1AR2zRhfEw-uUvML/view?usp=sharing)<br>
        * [학술지](https://www.dbpia.co.kr/Journal/articleDetail?nodeId=NODE12039232)


Algorithms
-------------
거래에서의 슬리피지를 줄이기위해서는 기술적인 최적화도 필요하지만 가스비를 포함한 자본의 리턴이 최종적으로 얼마인지를 생각해봐야합니다.
프로젝트에서는 ALD라는 방정식을 사용합니다. 방정식은 유동성과 가격의 상관관계에 대한 해석을 기반으로 실험을 통해 경험적으로 도출되었습니다.
<br><br>
ALD는 3가지 전략적인 배치방식을 제공합니다. 배치방식은 방정식에서 $s$ (유동성 배치 방식을 결정하기 위한 계수 decay) 값을 통해서 결정됩니다. 
양수,음수,0 세가지 유형을 유동성 크기에 따라 서서히 그 모습을 변화시키도록 고안되어 있다.

1. Concentrated Distruibution <br>
![img]({{ site.baseurl }}/assets/ald1.png){: style="width:500px;","display: block; margin: 0;" }

2. Inverted and Concentrated Distribution <br>
![img]({{ site.baseurl }}/assets/ald3.png){: style="width:500px;","display: block; margin: 0;" }

3. Cliff and Equalized, Inverted Distribution <br>
![img]({{ site.baseurl }}/assets/ald2.png){: style="width:500px;","display: block; margin: 0;" }
<br>

모든 데이터는 컨트랙트 개발 환경을 통해 추출하였다. AMM
모델은 유니스왑 공식 레포지토리를 참조하여 컨트랙트를 포크하여 구현하였고, ALD는 방정식을 온체인 컨트랙트로 구현했다. 
이를 통해 추출한 데이터는 Python 의 Matplotlib 을 통해 시각화하였다.
<br>

결과적으로 전략적 배치는 성공적으로 유동성에 따라서 유동적으로 변화하여 상황에 적합하게 동작할수있었다. 
이를 통해 아래와 같이 실제 바이낸스 BTC/USDT 차트의 MarketDepth를 상하반전된 형태로 보면 시장부근에 집중화된 형태의 유동성이 
분포가 되어있는것을 확인할수있다. 
<br>
![img]({{ site.baseurl }}/assets/ald4.png){: style="width:500px;","display: block; margin: 0;height:250px; object-fit: cover; object-position: top; display: block;" }
<p style="font-size: 0.8em; color: #666; margin-top: -10px; margin-left:100px">
  BTC/USDT Market Depth of Binance(2024.08.07)
</p>
<br>

Solidity Optimization
-------------
자본 효율성을 높이기 위해, 기술적으로 개선이 가능한 가스비 최적화 영역에 어셈블리 코드를 도입했다. 최신 Solidity 버전기준으로 함수 시그니처 검증, 리턴 데이터 크기와 타입 안전성, revert 처리 등 다양한 유효성 검증 기능이 내장되어 있지만, 어셈블리를 최소한의 형태로 직접 구현하는 것은 리스크가 높아진다. 
하지만 충분한 시나리오 기반 테스트를 통해 잠재적인 위험을 최소화할 수 있다고 판단하여, 해당 방법을 신중하게 적용하였다.


-------------
```
    function push(Type.Order memory _order) public returns (bytes32 _key) {
        unchecked {
            ...
            _push(_order.owner, _key);
            ...
        }
    }

    function _push(address _owner, bytes32 _key) internal {
        assembly {
            mstore(0x00, caller())
            mstore(0x20, keys.slot)
            let outerSlot := keccak256(0x00, 0x40)
            mstore(0x00, _owner)
            mstore(0x20, outerSlot)
            let innerSlot := keccak256(0x00, 0x40)

            let size := sload(innerSlot)
            mstore(0x00, innerSlot)
            let dataSlot := keccak256(0x00, 0x20)

            sstore(add(dataSlot, size), _key)
            sstore(innerSlot, add(size, 1))
        }
    }
```
위와 같이 이중배열에 저장할때 메모리 주소(0x00,0x20) 재사용하여 가스비를 줄이고 필요한 유효성 검사인(owner, key 값 확인 등)는 상위 호출에서 검사하게 구현하였다.
***가스비는 20% 절감했다.***


Extensible Proxy
-------------
일반적으로 Solidity는 Proxy패턴을 사용하는이유는 이미 배포된 계약을 다른 계약으로 교체하고 이로인한 상황에서 배포 가스비를 절감할수있다.
그러나 Solidity는 24kb로 컨트랙트의 비지니스로직과 기본적으로 생성되는 바이트코드들을 분리함으로 얻는 공간 확보외에 비지니스로직이 비대해지면 
확장성문제를 겪을수밖에없다. 온체인에 오더북을 구현하기위한 매칭엔진과 여러 주문 방식과 스테이킹 같은 서비스를 제공하기위해서는 해당 문제를 해결해야만했다. 
리서치를 통해 EIP-2535를 적용하여 확장성 문제를 해결하였다. 해당 솔루션은 구현복잡성이 올라가지만 이로인해 실행 가스비를 줄일수있는 optimaztion 수치를 크게 높여 가스비를 줄일수있는 
장점이었다. 결과적으로 매칭엔진을 통해서 사용자들이 주문을하는 경우에는 ***10%이상의 가스비*** 가 감소하였다.
<br><br>
최대한 경량화하여 프로젝트에 적용한 방식은 다음 [주소](https://github.com/Coinmeca/lightweight-diamond)를 통해서 확인가능하다. 
<br>



Backend
-------------
### overview
![img]({{ site.baseurl }}/assets/arc.png){: style="width:800px;","display: block; margin: 0;" }

백앤드가 없어도 Contract 요청많으로 거래및 서비스를 이용이 가능하다. 하지만 UX가 굉장히 안좋아지고 서비스라고 할수없는 수준이라서 백앤드 기술은 블록체인 서비스에 있어 가장 중요하다.
유니스왑V3 경우에도 Routing API 외부 백앤드 서비스에 의존하고있으면 만약 해당 서비스가없다면 핵심 기술이 없어지는거라 V3 의미가 사라진다. 실제로 V3 주력무기로 라우팅을 소개하였다. 





### GraphQL

### Business logic development

### Batcher


[1]: https://github.com/allejo/jekyll-toc
